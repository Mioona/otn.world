name: ðŸš€ Deploy to Infomaniak

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ” Load Infomaniak credentials from secret JSON
      id: creds
      run: |
        # Write secret JSON to file
        echo "${{ secrets.INFOMANIAK_SSH_NODEJS }}" > creds.json
        # Parse values
        HOST=$(jq -r '.host' creds.json)
        USER=$(jq -r '.username' creds.json)
        PASS=$(jq -r '.password' creds.json)
        # Mask values in logs
        echo "::add-mask::${PASS}"
        # Export for next steps
        echo "HOST=$HOST" >> $GITHUB_OUTPUT
        echo "USER=$USER" >> $GITHUB_OUTPUT
        echo "PASS=$PASS" >> $GITHUB_OUTPUT
      shell: bash

    - name: ðŸ”§ Install dependencies (ci)
      run: npm ci --omit=dev

    - name: ðŸš€ Deploy to Infomaniak (SFTP)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ steps.creds.outputs.HOST }}
        username: ${{ steps.creds.outputs.USER }}
        password: ${{ steps.creds.outputs.PASS }}
        local-dir: './'
        server-dir: '/web/'
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          .github/**
          README.md
          .gitignore
          DEPLOYMENT.md

    - name: ðŸ”„ Post-deploy (server install)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ steps.creds.outputs.HOST }}
        username: ${{ steps.creds.outputs.USER }}
        password: ${{ steps.creds.outputs.PASS }}
        script: |
          set -e
          cd /web/
          npm ci --omit=dev
          echo "âœ… Server dependencies installed"
